---
title: Шифрованный файл с паролями и ключами
date: 2015-05-04 19:50:19
tags:
 - encryption
 - linux
 - linux4all
---

Иногда хочется, чтобы на диске был файл, который был бы хранилищем паролей и любой другой конфиденциальной информации, которую нужно скрыть от других. Подходов для решения много, разные программы а-ля truecrypt и прочие. Но в linux есть и нативные средства для шифрования, одним из которых является `dm-crypt`. Сам файл будет содержать файловую систему, что позволит его монтировать как блочное устройство (раздел диска), а `dm-crypt` даст прозрачное шифрование (после монтирования файлы сразу же будут доступны).
Начнем. Для начала установим (если не установлен) `cryptsetup`:

```shell
aptitude install cryptsetup
```
Теперь создадим пустой файл, с которым мы будем работать. Есть в общем 3 способа это сделать:
1) традиционно, с помощью `dd`:

```shell
dd if=/dev/zero of=myencryptionfile bs=1M count=100
```

преимущество в том, что `dd` фактически перезапишет данные на диске нулями, что снизит вероятность восстановления предыдущих данных, а недостаток — медленно работает, так как использует ресурс процессора и диска.
2) с помощью `fallocate`:

```shell
fallocate -l 100M myencryptionfile
```

файл будет создан мгновенно, занимать он будет реально 100МБ и будет “неразрывным”, но есть вероятность восстановления информации, которая была ранее на диске, т.к. будет просто выделено место под файл, но на диск ничего не пишется.
3) с помощью `truncate`:

```shell
truncate -s 100M myencryptionfile
```

способ для этой задачи не подходящий. во-первых — все недостатки способа с fallocate + он создаёт файл, который якобы 100МБ, но по сути пока данных в нем меньше (как в случае с виртуальными дисками для виртуальных машин), он и занимает меньше, динамически расширяясь.
Создаём файл подходящим для нас образом (не забываем, что 100М — это 100МБ (1024×1024), а 100MB — это 1000×1000 (так же и остальные K, KB, G, GB)) Перед форматированием файла в какую-нибудь файловую систему, нам нужно создать LUKS раздел внутри файла. LUKS (Linux Unified Key Setup) — это стандарт для шифрования разделов. Этим и занимается dm-crypt, все делается очень просто:

```shell
cryptsetup -y luksFormat myencryptionfile

WARNING!
========
This will overwrite data on myencryptionfile irrevocably.

Are you sure? (Type uppercase yes): YES
Enter passphrase:
Verify passphrase:
```

Итак, что здесь происходит: для того, чтобы мы не затерли другой файл вместо нужного нам, нас просят все перепроверить и если все хорошо и файл нужный — написать большими буквами `YES`. Далее нужно ввести фразу (пароль) для шифрования (если забудете пароль, то если нет связей в АНБ, восстановить вряд ли получится). Опция `-y` означает, что нужно переспросить пароль после его ввода (чтобы исключить ошибку). Проверим, что у нас получилось:

```shell
file myencryptionfile
myencryptionfile: LUKS encrypted file, ver 1 [aes, xts-plain64, sha1] UUID: 30dfeae7-8830-48a5-92b3-3ac24d378a51
```

Теперь у нас есть контейнер в начале файла, который мы можем открыть так:

```shell
cryptsetup luksOpen myencryptionfile volume1
```

volume1 — он появится в списке файлов `/dev/mapper/volume1` (открыт как `loopback` устройство) Теперь у нас есть новое устройство, с которым мы можем работать как с обычным дисковым устройством, создадим на нем файловую систему:

```shell
mkfs.ext4 /dev/mapper/volume1
```

Далее создадим точку монтирования для нашего устройства и смонтируем его:

```shell
mkdir /mnt/cryptfile
mount /dev/mapper/volume1 /mnt/cryptfile
```

Можно посмотреть как он выглядит в системе:

```shell
df -h /dev/mapper/volume1
Файловая система    Размер Использовано  Дост Использовано% Cмонтировано в
/dev/mapper/volume1    91M         1,6M   83M            2% /mnt/cryptfile
```

Можно записывать все что заблагорассудится в этот каталог. Далее отключаем его:

```shell
umount /mnt/cryptfile
cryptsetup luksClose volume1
```

Все, файл закрыт и защищен паролем. Вот так просто можно скрыть нужную информацию в файле, чтобы никто не прочитал его.

Restored from [original](https://web.archive.org/web/20200206105915/http://conformist-mw.blogspot.com/2015/05/blog-post.html)
